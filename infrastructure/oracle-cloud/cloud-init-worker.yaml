#cloud-config
# TaskFlow - K3s Worker Node Cloud Init
# This script initializes K3s worker nodes on Oracle Cloud

# Update system packages
package_update: true
package_upgrade: true

# Install essential packages
packages:
  - curl
  - wget
  - git
  - vim
  - htop
  - unzip
  - jq
  - ufw
  - fail2ban

# Create users and groups
users:
  - name: taskflow
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

# Write files
write_files:
  # K3s agent configuration
  - path: /etc/rancher/k3s/config.yaml
    content: |
      server: https://${k3s_master_ip}:6443
      token: ${k3s_token}
      kubelet-arg:
        - "node-ip=$(hostname -I | awk '{print $1}')"
    permissions: '0644'
    owner: root:root

  # Firewall configuration
  - path: /etc/ufw/before.rules
    content: |
      # Allow K3s agent port
      -A ufw-before-input -p tcp --dport 10250 -j ACCEPT
      # Allow node port range
      -A ufw-before-input -p tcp --dport 30000:32767 -j ACCEPT
    permissions: '0644'
    owner: root:root

  # Fail2ban configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 3
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
    permissions: '0644'
    owner: root:root

  # System optimization
  - path: /etc/sysctl.d/99-k3s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-ip6tables = 1
    permissions: '0644'
    owner: root:root

# Run commands
runcmd:
  # Update system
  - apt-get update
  - apt-get upgrade -y

  # Configure firewall
  - ufw --force enable
  - ufw allow ssh
  - ufw allow 10250/tcp
  - ufw allow 30000:32767/tcp

  # Configure fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Apply sysctl settings
  - sysctl --system

  # Install K3s agent
  - curl -sfL https://get.k3s.io | sh -s - agent --config /etc/rancher/k3s/config.yaml

  # Wait for K3s agent to be ready
  - sleep 30

  # Set up log rotation
  - echo "/var/log/k3s-agent.log {" > /etc/logrotate.d/k3s-agent
  - echo "  daily" >> /etc/logrotate.d/k3s-agent
  - echo "  rotate 7" >> /etc/logrotate.d/k3s-agent
  - echo "  compress" >> /etc/logrotate.d/k3s-agent
  - echo "  delaycompress" >> /etc/logrotate.d/k3s-agent
  - echo "  missingok" >> /etc/logrotate.d/k3s-agent
  - echo "  notifempty" >> /etc/logrotate.d/k3s-agent
  - echo "}" >> /etc/logrotate.d/k3s-agent

  # Create welcome message
  - cat > /home/opc/welcome.txt <<EOF
    ========================================
    TaskFlow K3s Worker Node Ready!
    ========================================
    
    Worker IP: $(hostname -I | awk '{print $1}')
    Master IP: ${k3s_master_ip}
    K3s Agent Status: systemctl status k3s-agent
    K3s Agent Logs: journalctl -u k3s-agent -f
    
    Next Steps:
    1. Check with master: kubectl get nodes
    2. Deploy TaskFlow application
    3. Access via load balancer
    
    ========================================
    EOF

  - chown opc:opc /home/opc/welcome.txt

# Final message
final_message: |
  TaskFlow K3s Worker Node initialization complete!
  
  Worker IP: $(hostname -I | awk '{print $1}')
  Master IP: ${k3s_master_ip}
  K3s Agent Status: systemctl status k3s-agent
  
  Check /home/opc/welcome.txt for more information.